## 5.15

## ADS8688 Mode

### 메뉴얼모드 설명
현재 코드에서 사용되고 있는 모드는 메뉴얼 모드

메뉴얼모드는 한번에 하나의 채널만 선택해서 읽기 auto채널스캔모드와 반대(수동변환)

명령어로 직접 특정 채널을 선택해서 변환

### 메뉴얼 모드 선택 이유
- 온습도센서에 메뉴얼 모드를 선택한 이유는 온습도는 급격하게 변하지 않기 때문에 오토모드처럼 채널을 빠르게 돌리면서 읽을 필요가 없고
그래서 빠른 샘플링이 필요없다고 생각하였고 한번에 한 채널씩 요청하는 메뉴얼모드가 더 적절하다고 생각했습니다. 

- 비슷한 이유로 ads8688에는 8채널이 있는데 온습도는 2채널만 쓰기 때문에 불필요한 채널스캔을 줄이기 위해 선택했다고 생각합니다.

- 현재 상황처럼 습도만 이상치 데이터가 나오는 경우에 습도에 연결된 채널만 읽어서 확인하며 디버깅할때 편리하다고 생각합니다.

### 통신라인
- CS: 어떤 장치와 통신할 것인지 트리거 역할 LOW되는 순간에 변환시작 이전프레임에서 설정한 채널을 샘플 , HIGH가 되면 프레임종료 

- SCLK : 외부 클럭 신호를 받고 LOW 기준으로 SDI 읽고 SDO 출력 동작

- SDI : mcu가 ads8688에 설정명령 전달 , 16개 사이클동안 데이터 입력받기 [4비트 명령][4비트 채널 주소][8비트 데이터 or reserved]

- SDO : 16번째 SCLK 떨어지는 에지부터 MSB가 출력되며, 이후 데이터 비트가 계속해서 출력 후 고임피던스상태(열려있는상태)
   
- DAISY : 여러 장치를 다이징 체인 모드로 연결할 때 사용
***


RST/PD 쓰는 이유 : 짧게 low해서 레지스터 초기화하면 다시 안정적으로 센서값읽고 자주측정 안하기 때문 pd는 전원절전+초기

총 32bit를 쓰지만 16bit만 ADC변환 데이터

16비트에서 LSB비트는 16번째에서 읽고 17~32클럭에서는 SDO에서 변환데이터 MSB를 출력시작

데이지 체인모드 : 디바이스가 3개일때 16x3 = 48 에다가 맨처음 16bit 변환설정을 해야하므로 총 64SCLK가 필요 모든 핀이 공통

스타 토폴로지모드 : SDI,SCLK는 공통 연결 , SDO는 하나의 선에 병렬연결 , cs는 개별 선 연결 제어 

NO_OP모드 : 이전 설정 모드로 계속 동작, SDI선을 low로 유지하면 16비트 모두 0으로 설정 

전원 공급후 초기화되면 idle모드로 설정(대기상태)
***


1. 메뉴얼 채널 선택 명령 (MAN_Ch_n) 보내기
- 8비트 명령 + 8비트 채널 주소




### 현상황
보드에 전원만 연결하고 p12에 4번핀(원래의 습도핀) 과 gnd의 전압을 측정하였는데 4.9v가 나와서 
p12에 sp1번으로 옮기고 테스트를 해보았습니다. 그런뒤 전압은 정상적으로 현재습도와 비슷하게 출력이 되며 
옮겨드리는걸 부탁을 드리며 데이터시트를 보며 조금 더 찾아보겠습니다. 

현재 상황은 p21에 2번핀(습도핀)과 u12(bss138)의 3번핀이 서로 연결이 되어있는걸 회로도에서 확인을 하였고 

u12의 번핀의 전압을 측정하였더니 4.93v로 전압이 같은걸 확인했습니다. 

u12부분을 삭제 확인 검토부분

데이터시트를 좀더 보면서 원인을 더 찾아보겠습니다. 









***
읽기동작과정 
SDI
1. 앞쪽 7비트 (bit 15~9): 레지스터 주소

2. 1비트 (bit 8): 읽기/쓰기 플래그 (0: Write, 1: Read)

3. 8비트 (bit 7~0): 쓰고자 하는 데이터

SDO 16 하강엣지 이후부터 8비트 MSB부터 출력 

동작 종류가 여러개 있어서 클럭이나 비트 설정 확인
| 동작 종류                      | 최소 필요 SCLK 수            | 전체 프레임          | 비고                      |
| -------------------------- | ----------------------- | --------------- | ----------------------- |
| **Program Register Write** | 24비트                    | 32비트 프레임 안에 포함됨 | 남는 8비트는 무시 또는 dummy     |
| **Program Register Read**  | 24비트 (16비트 명령 + 8비트 출력) | 32비트 프레임 안에 포함됨 | 실제 유효 비트는 24            |
| **Command Register Write** | 16비트                    | 32비트 프레임 안에서 사용 | 16비트 명령만 필요, 나머지는 dummy |
| **Conversion Data Read**   | 32비트                    | 전체가 유효 데이터      | 변환 결과 16비트 + 상태 등       |




***
NO_OP이전값 읽는 이유 : ADC가 명령 받고 샘플링하는 데 시간(클럭)이 필요하므로 결과가 한 박자 뒤에 도착
 
SYSCLK : 400 MHz  

HCLK(AHB) : 200 MHz 

APB1(PCLK1) : 100 MHz  

APB2(PCLK2, SPI5) : 100 MHz  

ADC1 : 64MHz


측정할 채널 선택: cmdRegister(MAN_n, &SPI)

변환된 데이터 읽기: cmdRegister(CONT, &SPI) 또는 NO_OP(&SPI)

0x1F  0x06  0x00  0x00   // 예시: 채널 6 선택, 변환 시작

0x1F  0x06  0x00  0x00   // 예시: 채널 6 선택, 변환 시작




| 설정 항목                       | 설명                                         |
| --------------------------- | ------------------------------------------ |
| **채널 선택 (Channel Select)**  | 어떤 아날로그 입력 채널(Px)을 변환할지 선택 (예: CH5, CH6 등) |
| **입력 범위 설정 (Input Range)**  | ±2.5V, 0\~5V 등 어떤 전압 범위를 사용할지 선택           |
| **데이터 출력 형식 (Data Format)** | 바이너리, 2의 보수 등                              |
| **자동 변환/수동 변환 모드**          | 자동으로 계속 변환할지, 명령이 들어올 때만 변환할지 선택           |
| **파워 모드 설정**                | 저전력 모드 등                                   |

