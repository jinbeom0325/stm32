## MPS(Multi-Physical Sensors) 다물리센서 학습진행중
- 여러 물리적 데이터를 동시에 측정할 수 있는 센서 시스템을 의미
***
사용 센서 : 온도/습도, 함수비, 풍속, 간극수압, 강우량 센서 

함수비 : 흙 속의 포함된 물의 양을 나타내는 비율 (토양의 온습도를 측정)

간극수압 : 토양이나 암석의 공극(빈공간)에 존재하는 물이 주변에 미치는 정수압(바깥으로 밀어내는 압력)

***
약어 | 풀 네임 | 설명
--|--|--
DL | Data Logger | 센서 데이터를 저장하는 장치 또는 소프트웨어
Svr | Server | 데이터를 제공하거나 처리하는 주체
Cli | Client | 데이터를 요청하는 주체 (사용자 기기 등)
AP | Access Point | 무선 네트워크의 중심 노드 (Wi-Fi 연결 지점)
GW | Gateway | 서로 다른 네트워크/프로토콜을 중계
ADC | Analog-to-Digital Converter | 아날로그 신호를 디지털로 변환
GPIO | General Purpose Input/Output | MCU의 범용 입출력 핀
UART | Universal Asynchronous Receiver-Transmitter | MCU와 외부 장치 간 비동기 직렬 통신
***
### ADS8688(멀티채널 16비트 ADC) 데이터 로거
| 항목 | 설명 |
|------|------|
| **제조사** | Texas Instruments (TI) |
| **ADC 해상도** | 16-bit |
| **채널 수** | 8채널 (Single-ended 입력) |
| **입력 전압 범위** | 여러 가지 Full-Scale 범위 설정 가능 (예: ±10.24V, 0~10.24V 등) |
| **인터페이스** | SPI (Serial Peripheral Interface) |
| **샘플 속도** | 최대 500kSPS (샘플/초) |
| **내장 기능** | PGA, 입력 보호 회로, 온도 센서 등 |
| **동작 전압** | 5V (아날로그), 1.8V 또는 3.3V (디지털) |

### INA226
| 항목                     | 설명                                                                 |
|------------------------|----------------------------------------------------------------------|
| **제조사**               | Texas Instruments                                                   |
| **측정 전압 범위**        | 0V ~ 36V (버스 전압)                                                |
| **전류 측정 방식**        | 셔트 저항 기반 양방향 전류 측정                                     |
| **ADC 해상도**           | 16비트                                                               |
| **통신 인터페이스**       | I²C 또는 SMBus                                                      |
| **전원 공급 전압 (Vcc)** | 2.7V ~ 5.5V                                                         |
| **프로그래머블 주소 수**  | 최대 16개 I²C 주소 설정 가능                                          |
| **전력 소비**            | 평균 330 μA                                                        |
| **동작 온도 범위**       | -40°C ~ +125°C                                                     |
| **패키지 형태**          | VSSOP-10 (3.00mm × 4.90mm)                                          |
| **주요 응용 분야**        | 배터리 관리, 서버/통신 장비, 산업용 전원 모니터링, EV 전력 분석 등     |

​IS42S32800G는 ISSI에서 제조한 256Mb(32MB) 용량의 고속 SDRAM(Synchronous DRAM) 메모리
***
| 역할              | MCU                 | ADS8688     |
| --------------- | ------------------- | ----------- |
| **MCU (STM32)** | 중앙 제어, 통신 처리        | SPI 마스터 역할  |
| **ADS8688**     | 센서 데이터를 아날로그→디지털 변환 | SPI 슬레이브 역할 |

### 센서 부분

| 항목             | HTU21D      | LM35D                |
| -------------- | ----------- | -------------------- |
| 측정 항목          | 온도 + 습도     | 온도만                  |
| 출력 방식          | 디지털 (I2C)   | 아날로그 (전압)            |
| 정확도            | 상대적으로 높음    | 보통                   |
| 마이크로컨트롤러 연결 방식 | I2C 통신 핀 필요 | ADC 핀 필요             |
| 전압 변환 필요       | 불필요 (디지털)   | 필요 (ADC 레퍼런스와 매칭 필수) |
***
## 센서

### 온습도센서 HTU21D
| 센서 핀      | 연결 라벨     | 연결 설명                     |
| --------- | --------- | ------------------------- |
| VCC       | +3.3V   | 전원 공급                     |
| GND       | GND     | 그라운드                      |
| SCL (클럭)  | HUM_SCL | STM32의 I2C PB6 클럭 핀으로 연결  |
| SDA (데이터) | HUM_SDA | STM32의 I2C PB7 데이터 핀으로 연결 |

### 풍속센서
- ADC

| 센서 선 색상 | 기능    | 연결 설명                                |
| ------- | ----- | ------------------------------------ |
| BROWN   | VCC   | 12V 전원 공급                        |
| BLACK   | GND   | GND 연결                               |
| BLUE    | 출력 신호 | STM32의 PB0 핀에 연결 (0.4V \~ 2.0V 범위) |

### 강우량센서
- GPIO
  
| 센서 신호명     | 연결 핀  | 설명                                        |
| ---------- | ----- | ----------------------------------------- |
| Rain Pulse | PJ6 | STM32의 GPIO PJ6 핀에 연결<br>TIM8 기능 가능 |

***
p23부분이 온습도 센서부분이고

p7,p32부분이 풍속센서 p24부분이 강우량센서

풍속센서는 INA226 ADC를 이용한 풍속 값 측정이고

강우량은 외부인터럽트를 이용한 강우량 측정이고 

온습도센서는  ADS8688 ADC를 이용한 온도, 습도 값 측정


| 주변 장치 | 핀               | 설명                  |
| ----- | --------------- | ------------------- |
| ADC1  | PB0             | `ADC1_INP9` 아날로그 입력 |
| I2C1  | PB6, PB7        | 각각 SCL, SDA         |
| SPI5  | PK0, PJ11, PJ10 | 각각 SCK, MISO, MOSI  |


임계값 : 경계선 이상의 값 (센서가 임계값을 초과했는지 확인하기 위해)

***
### 2025.05.12
## 습도센서 오차 
| 항목            | 값 / 설명                                    |
| ------------- | ----------------------------------------- |
| 센서 전원         | 5V (센서 사양에 맞음)                            |
| 센서 출력 전압      | 4.08V (멀티미터 측정값)                          |
| 실제 습도         | 약 60% (기상 정보 기준 등)                        |
| ADS8688 읽은 값  | 약 52250 (16bit 값, 0\~65535 범위)            |
| 코드 계산 결과      | 습도 90% 이상 (오차)                        |
| ADS8688 입력 범위 | R5 설정 (0 \~ 1.25 × Vref = 0 \~ **5.12V**) |
| Vref          | 4.096V (코드 내 `_vref`)                     |
| 입력 범위 최대값     | 4.096 × 1.25 = 5.12V                      |
***
### ads8688기능
| 항목        | 설명                                     |
| --------- | -------------------------------------- |
| 아날로그 입력   | 8채널 (CH0\~CH7), 싱글엔디드                  |
| 해상도       | 16비트                                   |
| 인터페이스     | SPI (최대 50MHz)                         |
| 입력 전압 범위  | ±2.5×Vref, ±1.25×Vref 등 **범위 선택 가능**   |
| 내부 Vref   | 4.096V (사용자가 외부로도 설정 가능)               |
| 샘플링 방식    | SAR(Successive Approximation Register) |
| 채널별 전원 끄기 | 지원 (저전력 모드)                            |
| 데이터 포맷    | 16비트 unsigned integer                  |
***
```c
ADS8688 ADC칩 채널5번,6번 입력전압 범위 설정 

void vChannel6SetR5(ADS8688 *ads)
{
	setChannelRange(SPI_Channel6, R5, ads);             
}
void vChannel5SetR5(ADS8688 *ads)
{
	setChannelRange(SPI_Channel5, R5, ads);
}
```
| 요소                  | 의미                                 |
| ------------------- | ---------------------------------- |
| `ADS8688 *ads`      | ADS8688 구조체 포인터 (SPI 통신, 상태 등 저장됨) |
| `SPI_Channel5/6`    | ADS8688 내부의 채널 번호 (CH5, CH6)       |
| `R5`                | 전압 입력 범위 설정 값. 예: `±2.5 × Vref` 등  |
| `setChannelRange()` | ADS8688에 특정 채널과 전압 범위를 설정하는 내부 함수  |
***
입력전압범위 (4.096V)
| 코드   | 이름               | 전압 범위       |
| ---- | ---------------- | ----------- |
| `R1` | ±2.5 × Vref      | ±10.24V     |
| `R2` | ±1.25 × Vref     | ±5.12V      |
| `R3` | ±0.625 × Vref    | ±2.56V      |
| `R4` | 0 \~ 2.5 × Vref  | 0 \~ 10.24V |
| `R5` | 0 \~ 1.25 × Vref | 0 \~ 5.12V  |

| 모드 이름                | 설명                 |
| -------------------- | ------------------ |
| **Auto Mode**        | 자동으로 채널들을 순차적으로 스캔 |
| **Manual Mode**      | 사용자가 선택한 채널만 변환    |
| **Auto-Repeat Mode** | 특정 채널 하나만 계속 반복 변환 |
| **Reset Mode**       | 기본값 복원 또는 초기화      |
***

| 모드 이름       | 의미       | 용도 예시                            |
| ----------- | -------- | -------------------------------- |
| `MODE_IDLE` | 대기 모드    | 아무 동작 안 하는 기본 상태                 |
| `MODE_PROG` | 프로그래밍 모드 | 레지스터 설정(채널 설정, 범위 설정 등)을 수행하는 상태 |
***
***
***
# 5.15

## ADS8688 Mode

### 메뉴얼모드 설명
현재 코드에서 사용되고 있는 모드는 메뉴얼 모드

메뉴얼모드는 한번에 하나의 채널만 선택해서 읽기 auto채널스캔모드와 반대(수동변환)

명령어로 직접 특정 채널을 선택해서 변환

### 메뉴얼 모드 선택 이유
- 온습도센서에 메뉴얼 모드를 선택한 이유는 온습도는 급격하게 변하지 않기 때문에 오토모드처럼 채널을 빠르게 돌리면서 읽을 필요가 없고
그래서 빠른 샘플링이 필요없다고 생각하였고 한번에 한 채널씩 요청하는 메뉴얼모드가 더 적절하다고 생각했습니다. 

- 비슷한 이유로 ads8688에는 8채널이 있는데 온습도는 2채널만 쓰기 때문에 불필요한 채널스캔을 줄이기 위해 선택했다고 생각합니다.

- 현재 상황처럼 습도만 이상치 데이터가 나오는 경우에 습도에 연결된 채널만 읽어서 확인하며 디버깅할때 편리하다고 생각합니다.

### 통신라인
- CS: 어떤 장치와 통신할 것인지 트리거 역할 LOW되는 순간에 변환시작 이전프레임에서 설정한 채널을 샘플 , HIGH가 되면 프레임종료 

- SCLK : 외부 클럭 신호를 받고 LOW 기준으로 SDI 읽고 SDO 출력 동작

- SDI : mcu가 ads8688에 설정명령 전달 , 16개 사이클동안 데이터 입력받기 [4비트 명령][4비트 채널 주소][8비트 데이터 or reserved]

- SDO : 16번째 SCLK 떨어지는 에지부터 MSB가 출력되며, 이후 데이터 비트가 계속해서 출력 후 고임피던스상태(열려있는상태)
   
- DAISY : 여러 장치를 다이징 체인 모드로 연결할 때 사용
***


RST/PD 쓰는 이유 : 짧게 low해서 레지스터 초기화하면 다시 안정적으로 센서값읽고 자주측정 안하기 때문 pd는 전원절전+초기

총 32bit를 쓰지만 16bit만 ADC변환 데이터

16비트에서 LSB비트는 16번째에서 읽고 17~32클럭에서는 SDO에서 변환데이터 MSB를 출력시작

데이지 체인모드 : 디바이스가 3개일때 16x3 = 48 에다가 맨처음 16bit 변환설정을 해야하므로 총 64SCLK가 필요 모든 핀이 공통

스타 토폴로지모드 : SDI,SCLK는 공통 연결 , SDO는 하나의 선에 병렬연결 , cs는 개별 선 연결 제어 

NO_OP모드 : 이전 설정 모드로 계속 동작, SDI선을 low로 유지하면 16비트 모두 0으로 설정 

전원 공급후 초기화되면 idle모드로 설정(대기상태)
***


1. 메뉴얼 채널 선택 명령 (MAN_Ch_n) 보내기
- 8비트 명령 + 8비트 채널 주소




### 현상황
보드에 전원만 연결하고 p12에 4번핀(원래의 습도핀) 과 gnd의 전압을 측정하였는데 4.9v가 나와서 
p12에 sp1번으로 옮기고 테스트를 해보았습니다. 그런뒤 전압은 정상적으로 현재습도와 비슷하게 출력이 되며 
옮겨드리는걸 부탁을 드리며 데이터시트를 보며 조금 더 찾아보겠습니다. 

현재 상황은 p21에 2번핀(습도핀)과 u12(bss138)의 3번핀이 서로 연결이 되어있는걸 회로도에서 확인을 하였고 

u12의 번핀의 전압을 측정하였더니 4.93v로 전압이 같은걸 확인했습니다. 

강우량은 1분단위로 큐에 저장된 값의 평균 1시간이 지나면 전체 타이머 초기화  
습도 (%) = (ADC 값) × (LSB 전압) × (입력 전압 보정 비율)






***
읽기동작과정 
SDI
1. 앞쪽 7비트 (bit 15~9): 레지스터 주소

2. 1비트 (bit 8): 읽기/쓰기 플래그 (0: Write, 1: Read)

3. 8비트 (bit 7~0): 쓰고자 하는 데이터

SDO 16 하강엣지 이후부터 8비트 MSB부터 출력 

동작 종류가 여러개 있어서 클럭이나 비트 설정 확인
| 동작 종류                      | 최소 필요 SCLK 수            | 전체 프레임          | 비고                      |
| -------------------------- | ----------------------- | --------------- | ----------------------- |
| **Program Register Write** | 24비트                    | 32비트 프레임 안에 포함됨 | 남는 8비트는 무시 또는 dummy     |
| **Program Register Read**  | 24비트 (16비트 명령 + 8비트 출력) | 32비트 프레임 안에 포함됨 | 실제 유효 비트는 24            |
| **Command Register Write** | 16비트                    | 32비트 프레임 안에서 사용 | 16비트 명령만 필요, 나머지는 dummy |
| **Conversion Data Read**   | 32비트                    | 전체가 유효 데이터      | 변환 결과 16비트 + 상태 등       |




***
NO_OP이전값 읽는 이유 : ADC가 명령 받고 샘플링하는 데 시간(클럭)이 필요하므로 결과가 한 박자 뒤에 도착
 
SYSCLK : 400 MHz  

HCLK(AHB) : 200 MHz 

APB1(PCLK1) : 100 MHz  

APB2(PCLK2, SPI5) : 100 MHz  

ADC1 : 64MHz


측정할 채널 선택: cmdRegister(MAN_n, &SPI)

변환된 데이터 읽기: cmdRegister(CONT, &SPI) 또는 NO_OP(&SPI)

0x1F  0x06  0x00  0x00   // 예시: 채널 6 선택, 변환 시작

0x1F  0x06  0x00  0x00   // 예시: 채널 6 선택, 변환 시작




| 설정 항목                       | 설명                                         |
| --------------------------- | ------------------------------------------ |
| **채널 선택 (Channel Select)**  | 어떤 아날로그 입력 채널(Px)을 변환할지 선택 (예: CH5, CH6 등) |
| **입력 범위 설정 (Input Range)**  | ±2.5V, 0\~5V 등 어떤 전압 범위를 사용할지 선택           |
| **데이터 출력 형식 (Data Format)** | 바이너리, 2의 보수 등                              |
| **자동 변환/수동 변환 모드**          | 자동으로 계속 변환할지, 명령이 들어올 때만 변환할지 선택           |
| **파워 모드 설정**                | 저전력 모드 등                                   |






